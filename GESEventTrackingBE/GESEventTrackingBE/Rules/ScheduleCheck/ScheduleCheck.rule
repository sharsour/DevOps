/**
 * @description This rule handles the Timer events triggered by BW to check SLA of various entities.
 * @author HYDPCM228839D
 */
rule Rules.ScheduleCheck.ScheduleCheck {
	attribute {
		priority = 5;
		forwardChain = true;
	}
	declare {
		Events.Input.ScheduleCheckEvent schedulecheckevent;
	}
	when {
		
	}
	then {
		System.debugOut(" In schedulecheck rule");
		
		//Logging.
		boolean cleFlag=System.getGlobalVariableAsBoolean("CLEparams/CLE_Entity_Flag",true);
		String gesAgentId=Engine.engineName();
		if(cleFlag)
		{
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns2=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd3\" xmlns:ns3=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" xmlns:ns4=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" version=\"1.0\" exclude-result-prefixes=\"ns2 ns1 xsl ns4 ns ns3 xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"schedulecheckevent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"concat($schedulecheckevent/payload/ns4:TimerEvent/ns4:TimerType,$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck)\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;Plant_Num&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;Start Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($schedulecheckevent/payload)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
		
		try
		{
			String ordLock=System.getGlobalVariableAsString("EXTIDS/ORD_LOCK","ORD_LOCK");
			String ordToken=System.getGlobalVariableAsString("EXTIDS/ORDER_TOKEN","ORDER_TOKEN");
			String optimization=System.getGlobalVariableAsString("EXTIDS/OPTIMIZATION","OPTIMIZATION");
			String allTripsAtPWM=System.getGlobalVariableAsString("EXTIDS/ALL_TRIPS_AT_PWM","ALL_TRIPS_AT_PWM");
			String plantSummaryKey=System.getGlobalVariableAsString("EXTIDS/PLANT_SUMMARY","PLANT_SUMMARY");
			String timerType=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$schedulecheckevent/payload/xsd3:TimerEvent/xsd3:TimerType</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" pfx=\"xsd3\"/>\n    </namespaces>\n    <variables>\n        <variable>schedulecheckevent</variable>\n    </variables>\n</xpath>");
			String plantNum=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$schedulecheckevent/payload/xsd3:TimerEvent/xsd3:PlantNum</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" pfx=\"xsd3\"/>\n    </namespaces>\n    <variables>\n        <variable>schedulecheckevent</variable>\n    </variables>\n</xpath>");
			String shipDate=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$schedulecheckevent/payload/xsd3:TimerEvent/xsd3:ShipDate</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" pfx=\"xsd3\"/>\n    </namespaces>\n    <variables>\n        <variable>schedulecheckevent</variable>\n    </variables>\n</xpath>");
			String eval=System.getGlobalVariableAsString("SLA/STATUS/INITIAL","EVAL");
			String pass=System.getGlobalVariableAsString("SLA/STATUS/SUCCESS","PASS");
			String late=System.getGlobalVariableAsString("SLA/STATUS/FIRSTFAIL","LATE");
			String fail=System.getGlobalVariableAsString("SLA/STATUS/SECONDFAIL","FAIL");
			
			
			//Retrieve Plant Name by using Plant Number from Order Event.
			Concepts.PLANT_TIMEZONE plantTZ=Instance.getByExtIdByUri(System.getGlobalVariableAsString("EXTIDS/PLANT_TZONE","PLANT_TZONE"),"/Concepts/PLANT_TIMEZONE");
			String plantName=RuleFunctions.Inference.CommonRF.getPlantName(plantNum/*plantNum String */,plantTZ/*plantTZ Concepts.PLANT_TIMEZONE */);
			String entityExtId;
			
			if(timerType==allTripsAtPWM)
			{
				entityExtId=plantSummaryKey+plantNum+shipDate;
			}
			else
			{
				entityExtId=timerType+plantNum+shipDate;
			}
			
			
			if(timerType==ordLock)
			{
				Concepts.SAP_ORDER_LOCK ordLockInstance=Instance.getByExtIdByUri(entityExtId,"/Concepts/SAP_ORDER_LOCK");
				if(ordLockInstance==null)
				{
					ordLockInstance=Instance.createInstance("xslt://{{/Concepts/SAP_ORDER_LOCK}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"1.0\" exclude-result-prefixes=\"xsl xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"entityExtId\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"shipDate\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$entityExtId\"/>\n                </xsl:attribute>\n                <PLANT_NUM>\n                    <xsl:value-of select=\"$plantNum\"/>\n                </PLANT_NUM>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$shipDate\"/>\n                </SHIP_DATE>\n                <STATUS>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/SECONDFAIL\"/>\n                </STATUS>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				
				//Sending the alert to business user.
				Events.Alert.Alert alert=Event.createEvent("xslt://{{/Events/Alert/Alert}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.tibco.com/schemas/GESEventsMonitoring_testing/SharedResources/SchemaDefinitions/Alerts/Schema.xsd\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"ordLockInstance\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:IndividualAlert>\n                        <xsl:if test=\"$ordLockInstance/PLANT_NUM\">\n                            <ns:Plant_Num>\n                                <xsl:value-of select=\"$ordLockInstance/PLANT_NUM\"/>\n                            </ns:Plant_Num>\n                        </xsl:if>\n                        <xsl:if test=\"$ordLockInstance/SHIP_DATE\">\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$ordLockInstance/SHIP_DATE\"/>\n                            </ns:ShipDate>\n                        </xsl:if>\n                        <ns:Entity_Type>\n                            <xsl:value-of select=\"$globalVariables/EXTIDS/ORD_LOCK\"/>\n                        </ns:Entity_Type>\n                        <xsl:if test=\"$ordLockInstance/STATUS\">\n                            <ns:Status>\n                                <xsl:value-of select=\"$ordLockInstance/STATUS\"/>\n                            </ns:Status>\n                        </xsl:if>\n                        <ns:Time>\n                            <xsl:value-of select=\"if(string-length($ordLockInstance/LOCKTIMESTAMP)>0)&#xA;then $ordLockInstance/LOCKTIMESTAMP&#xA;else &#xA;tib:format-dateTime(&quot;MM-dd-yyyy HH:mm:ss.SSS&quot;, current-dateTime())\"/>\n                        </ns:Time>\n                    </ns:IndividualAlert>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Event.sendEvent(alert);
				
			}
			else if(timerType==ordToken)
			{
				Concepts.TOKEN ordTokenInstance=Instance.getByExtIdByUri(entityExtId,"/Concepts/TOKEN");
				if(ordTokenInstance==null)
				{
					ordTokenInstance=Instance.createInstance("xslt://{{/Concepts/TOKEN}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"1.0\" exclude-result-prefixes=\"xsl xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"entityExtId\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"shipDate\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$entityExtId\"/>\n                </xsl:attribute>\n                <PLANT_NUM>\n                    <xsl:value-of select=\"$plantNum\"/>\n                </PLANT_NUM>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <SHIPDATE>\n                    <xsl:value-of select=\"$shipDate\"/>\n                </SHIPDATE>\n                <STATUS>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/SECONDFAIL\"/>\n                </STATUS>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				
				//Sending the alert to business user.
				Events.Alert.Alert alert=Event.createEvent("xslt://{{/Events/Alert/Alert}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.tibco.com/schemas/GESEventsMonitoring_testing/SharedResources/SchemaDefinitions/Alerts/Schema.xsd\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"ordTokenInstance\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:IndividualAlert>\n                        <xsl:if test=\"$ordTokenInstance/PLANT_NUM\">\n                            <ns:Plant_Num>\n                                <xsl:value-of select=\"$ordTokenInstance/PLANT_NUM\"/>\n                            </ns:Plant_Num>\n                        </xsl:if>\n                        <xsl:if test=\"$ordTokenInstance/SHIPDATE\">\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$ordTokenInstance/SHIPDATE\"/>\n                            </ns:ShipDate>\n                        </xsl:if>\n                        <ns:Entity_Type>\n                            <xsl:value-of select=\"$globalVariables/EXTIDS/ORDER_TOKEN\"/>\n                        </ns:Entity_Type>\n                        <xsl:if test=\"$ordTokenInstance/STATUS\">\n                            <ns:Status>\n                                <xsl:value-of select=\"$ordTokenInstance/STATUS\"/>\n                            </ns:Status>\n                        </xsl:if>\n                        <ns:Time>\n                            <xsl:value-of select=\"if(string-length($ordTokenInstance/TOKEN_GOA_RECIEVETIME)>0)&#xA;then $ordTokenInstance/TOKEN_GOA_RECIEVETIME&#xA;else&#xA;tib:format-dateTime(&quot;MM-dd-yyyy HH:mm:ss.SSS&quot;, current-dateTime())\"/>\n                        </ns:Time>\n                    </ns:IndividualAlert>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Event.sendEvent(alert);
				
			}
			else if(timerType==optimization)
			{
				Concepts.OPTIMIZATION optimizationInstance=Instance.getByExtIdByUri(entityExtId,"/Concepts/OPTIMIZATION");
				if(optimizationInstance==null)
				{
					optimizationInstance=Instance.createInstance("xslt://{{/Concepts/OPTIMIZATION}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"1.0\" exclude-result-prefixes=\"xsl xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"entityExtId\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"shipDate\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$entityExtId\"/>\n                </xsl:attribute>\n                <PLANT_NUM>\n                    <xsl:value-of select=\"$plantNum\"/>\n                </PLANT_NUM>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$shipDate\"/>\n                </SHIP_DATE>\n                <STATUS>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/SECONDFAIL\"/>\n                </STATUS>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				
				//Sending the alert to business user.
				Events.Alert.Alert alert=Event.createEvent("xslt://{{/Events/Alert/Alert}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.tibco.com/schemas/GESEventsMonitoring_testing/SharedResources/SchemaDefinitions/Alerts/Schema.xsd\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"optimizationInstance\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:IndividualAlert>\n                        <xsl:if test=\"$optimizationInstance/PLANT_NUM\">\n                            <ns:Plant_Num>\n                                <xsl:value-of select=\"$optimizationInstance/PLANT_NUM\"/>\n                            </ns:Plant_Num>\n                        </xsl:if>\n                        <xsl:if test=\"$optimizationInstance/SHIP_DATE\">\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$optimizationInstance/SHIP_DATE\"/>\n                            </ns:ShipDate>\n                        </xsl:if>\n                        <ns:Entity_Type>\n                            <xsl:value-of select=\"$globalVariables/EXTIDS/OPTIMIZATION\"/>\n                        </ns:Entity_Type>\n                        <xsl:if test=\"$optimizationInstance/STATUS\">\n                            <ns:Status>\n                                <xsl:value-of select=\"$optimizationInstance/STATUS\"/>\n                            </ns:Status>\n                        </xsl:if>\n                        <ns:Time>\n                            <xsl:value-of select=\"if(string-length($optimizationInstance/OPTIMIZATION_TIMESTAMP)>0)&#xA;then $optimizationInstance/OPTIMIZATION_TIMESTAMP&#xA;else  tib:format-dateTime(&quot;MM-dd-yyyy HH:mm:ss.SSS&quot;, current-dateTime())\"/>\n                        </ns:Time>\n                    </ns:IndividualAlert>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Event.sendEvent(alert);
				
			}
			else if(timerType==allTripsAtPWM)
			{
				Concepts.PLANT_SUMMARY plantSummaryInstance=Instance.getByExtIdByUri(entityExtId,"/Concepts/PLANT_SUMMARY");
				if(plantSummaryInstance==null)
				{
					plantSummaryInstance=Instance.createInstance("xslt://{{/Concepts/PLANT_SUMMARY}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" xmlns:ns1=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"schedulecheckevent\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY,$schedulecheckevent/payload/ns1:TimerEvent/ns1:PlantNum,$schedulecheckevent/payload/ns1:TimerEvent/ns1:ShipDate)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:PlantNum\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:PlantNum\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <xsl:if test=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:ShipDate\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:ShipDate\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <ALL_TRIPS_AT_SITE>\n                    <xsl:value-of select=\"false()\"/>\n                </ALL_TRIPS_AT_SITE>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <ALL_TRIPS_AT_SITE_CHECK>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/SECONDFAIL\"/>\n                </ALL_TRIPS_AT_SITE_CHECK>\n                <ALL_TRIPS_AT_SITE_TIME>\n                    <xsl:value-of select=\"tib:format-dateTime(&quot;MM-dd-yyyy HH:mm:ss.SSS&quot;,current-dateTime())\"/>\n                </ALL_TRIPS_AT_SITE_TIME>\n                <ALL_TRIPS_AT_SITE_SCHEDULER_CHECK>\n                    <xsl:value-of select=\"true()\"/>\n                </ALL_TRIPS_AT_SITE_SCHEDULER_CHECK>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				else
				{
					plantSummaryInstance.ALL_TRIPS_AT_SITE_SCHEDULER_CHECK=true;
					if((plantSummaryInstance.PWM_TRIP_CNT - plantSummaryInstance.ETM_TRIP_CNT)==0 && plantSummaryInstance.ETM_TRIP_CNT>0)
					{
						if(plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK!=pass)
						{
							plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK=pass;
							plantSummaryInstance.ALL_TRIPS_AT_SITE_TIME=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr> tib:format-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", current-dateTime())</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables/>\n</xpath>");
							System.debugOut("ALL_TRIPS_AT_SITE status is set as "+plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK+" for plantNum = "+plantSummaryInstance.PLANT_NUM+" & ShipDate = "+plantSummaryInstance.SHIP_DATE);
						}
						
					}
					else 
					{
						if(plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK!=fail)
						{
							//Updating the latest check time for AllTripsAtPWM.
							plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK=fail;
							plantSummaryInstance.ALL_TRIPS_AT_SITE_TIME=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr> tib:format-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", current-dateTime())</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables/>\n</xpath>");
							System.debugOut("ALL_TRIPS_AT_SITE status is set as "+plantSummaryInstance.ALL_TRIPS_AT_SITE_CHECK+" for plantNum = "+plantSummaryInstance.PLANT_NUM+" & ShipDate = "+plantSummaryInstance.SHIP_DATE);
						}
						else
						{
							plantSummaryInstance.ALL_TRIPS_AT_SITE_TIME=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr> tib:format-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", current-dateTime())</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables/>\n</xpath>");
							System.debugOut("ALL_TRIPS_AT_SITE check time is updated");
						}
						
					}
					
				}
				
				RuleFunctions.Inference.CommonRF.consolidatedAlert(plantNum/*plantNum String */,shipDate/*shipDate String */);
				
				
			}
			else
			{
				System.debugOut(" Un-expected Timer type from BW = "+timerType);
			}
		}
		catch(Exception e)
		{
			System.debugOut("Exception caught in processing ScheduleCheck rule = "+e@errorType);
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns1=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"schedulecheckevent\"/>\n    <xsl:param name=\"e\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck\"/>\n                            </ns:ComponentName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"concat($schedulecheckevent/payload/ns1:TimerEvent/ns1:TimerType,$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck)\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:PlantNum\">\n                                <ns:BusinessID>\n                                    <xsl:value-of select=\"$schedulecheckevent/payload/ns1:TimerEvent/ns1:PlantNum\"/>\n                                </ns:BusinessID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$e/@errorType\"/>\n                        </ns:Code>\n                        <xsl:if test=\"$e/@message\">\n                            <ns:Message>\n                                <xsl:value-of select=\"$e/@message\"/>\n                            </ns:Message>\n                        </xsl:if>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($schedulecheckevent)\"/>\n                        </ns:TransactionData>\n                        <ns:DumpAnalysis>\n                            <xsl:value-of select=\"string($e)\"/>\n                        </ns:DumpAnalysis>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
			
		finally
		{
			if(cleFlag)
			{
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns2=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd3\" xmlns:ns3=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd\" xmlns:ns4=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd77\" version=\"1.0\" exclude-result-prefixes=\"ns2 ns1 xsl ns4 ns ns3 xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"schedulecheckevent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"concat($schedulecheckevent/payload/ns4:TimerEvent/ns4:TimerType,$globalVariables/CLEparams/CLE_ComponentNames/ScheduleCheck)\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;Plant_Num&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"$schedulecheckevent/payload/ns4:TimerEvent/ns4:PlantNum\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;End Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($schedulecheckevent/payload)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			
			//Consuming the Event.
			Event.consumeEvent(schedulecheckevent);
		}
	}
}