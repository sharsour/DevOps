/**
 * @description This rule updates the Order concept with the data of incoming SAP-OUT Order Event.
 * @author HYDPCM228839D
 */
rule Rules.OrderFlow.SAPOUTOrderUpdation {
	attribute {
		priority = 1;
		forwardChain = true;
	}
	declare {
		Events.Input.OrderEvent	orderEvent;
		Concepts.ORDERS order;
			
	}
	when {
		//Checking the System Name in Order Event.
		System.getGlobalVariableAsString("OrderSystems/InputSystems/SAPOUT","SAPOUT")==XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:System</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
		//Correlating Legacy Order Num in Order Event and Order Concept in Normal Order Scenario. 
		order.LGCY_ORD_NUM==XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Lgcy_Ord_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>") ||
		//Correlating Legacy Order Num in Order Event and Order Concept in Duplicate Order Scenario.
		order.OLD_LGCY_ORD_NUM==XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Lgcy_Ord_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>") ;	
	
	}
	then {
		System.debugOut("In SAP OUT Order Updation rule");
		
		//Logging.
		boolean cleFlag=System.getGlobalVariableAsBoolean("CLEparams/CLE_Flag",true);
		String gesAgentId=Engine.engineName();
		if(cleFlag)
		{
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_TransactionType/OrderFlow\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                                <ns1:TransactionID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                                </ns1:TransactionID>\n                            </xsl:if>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Started processing Order Event at &quot;,$orderEvent/payload/ns:ORDER/ns:System)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;Start Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($orderEvent)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
		
		try
		{
			String wats=System.getGlobalVariableAsString("OrderSystems/ActualSystems/WATS","WATS");
			String sap=System.getGlobalVariableAsString("OrderSystems/ActualSystems/SAP","SAP");
			String pwm=System.getGlobalVariableAsString("OrderSystems/ActualSystems/PWM","PWM");
			String etmGoa=System.getGlobalVariableAsString("OrderSystems/ActualSystems/ETM-GOA","ETM-GOA");
			Concepts.ORDER_SYSSTATE [] order_SysState=Instance.PropertyArray.toArrayContainedConcept(order.SYSSTATE);
			Concepts.ORDER_SYSSTATE wats_SysState=RuleFunctions.Inference.OrderFlowRF.getOrderSysState(order_SysState/*order_SysSyate Concepts.ORDER_SYSSTATE[] */,wats/*system String */);
			Concepts.ORDER_SYSSTATE sap_SysState=RuleFunctions.Inference.OrderFlowRF.getOrderSysState(order_SysState/*order_SysSyate Concepts.ORDER_SYSSTATE[] */,sap/*system String */);
			Concepts.ORDER_SYSSTATE pwm_SysState=RuleFunctions.Inference.OrderFlowRF.getOrderSysState(order_SysState/*order_SysSyate Concepts.ORDER_SYSSTATE[] */,pwm/*system String */);
			Concepts.ORDER_SYSSTATE etmGoa_SysState=RuleFunctions.Inference.OrderFlowRF.getOrderSysState(order_SysState/*order_SysSyate Concepts.ORDER_SYSSTATE[] */,etmGoa/*system String */);
			String ordType=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ord_Type</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
			String manual=System.getGlobalVariableAsString("OrderType/MANUAL","MANUAL"),cancelled=System.getGlobalVariableAsString("OrderType/CANCELLED_ORDER","CANCELLED");
			String sap_DelDate=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Delivery_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
			boolean delDate_Changed=false;
			
			
			String incoming_OrdNum=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Lgcy_Ord_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
			long incoming_SapOutTime=DateTime.getTimeInMillis(XPath.evalAsDateTime("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>tib:parse-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", $orderEvent/payload/xsd2:ORDER/xsd2:JMSDateTime)</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>"));
			String sapSLA="EVAL",e2eSLA=order.E2ESLA;
			
			//Checking if ShipDate is empty.
			String shipDate=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
			if(shipDate==null)
			{
				System.debugOut("Empty ShipDate");
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"&quot;ORDER&quot;\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$order/PLANT_NUM\">\n                                <ns:BusinessID>\n                                    <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                                </ns:BusinessID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/InvalidShipDate/code\"/>\n                        </ns:Code>\n                        <ns:Message>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/InvalidShipDate/message\"/>\n                        </ns:Message>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($orderEvent/payload)\"/>\n                        </ns:TransactionData>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			else
			{		
				//############################Checking if the incoming orderEvent is 2nd SAPOUT event after receiving the message from DRF incase of orderReNum scenario############################ 
				if(order.SAP_RECEIVED)
				{
					long existing_SapOutTime=DateTime.getTimeInMillis(XPath.evalAsDateTime("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>tib:parse-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", $sap_SysState/OUT_DATETIME)</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>sap_SysState</variable>\n    </variables>\n</xpath>"));
					if(ordType==cancelled && order.ORD_TYPE!=cancelled)
					{
						//Decrement the counts in the plantsummary concept.
						Events.Internal.PlantSummaryEvent oldPlantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then -1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/HH) then -1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then -1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$manual) then -1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($etmGoa_SysState/SYSTEM)!=0 ) then -1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0 - $order/CASES\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/ORD_TYPE=$globalVariables/OrderType/HH or $order/ORD_TYPE=$manual) and $order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL)&#xA; then -1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if ((string-length($sap_SysState/SLA)!=0) and $sap_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL)&#xA;then -1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH and string-length($sap_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"1\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/IN_DATETIME)!=0) then -1 else 0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
						Event.sendEvent(oldPlantSummaryEvent);
						System.debugOut("Order is cancelled and summary is updated accordingly :"+order@extId);
						order.ORD_TYPE = cancelled;
						order.CANCELLED_ORDER = true;
						order.E2ESLA = System.getGlobalVariableAsString("SLA/STATUS/SUCCESS","PASS");;
						
					}
					else if(order.DELIVERY_DATE!=sap_DelDate)
					{
						//Decrement the counts in the plantsummary concept with old ShipDate.
						Events.Internal.PlantSummaryEvent oldPlantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then -1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/HH) then -1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then -1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$manual) then -1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($etmGoa_SysState/SYSTEM)!=0 ) then -1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0 - $order/CASES\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/ORD_TYPE=$globalVariables/OrderType/HH or $order/ORD_TYPE=$manual) and ($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($sap_SysState/SLA)!=0) and ($sap_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then -1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/IN_DATETIME)!=0) then -1 else 0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE!=$globalVariables/OrderType/CANCELLED_ORDER and string-length($sap_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH  and string-length($sap_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/CANCELLED_ORDER) then -1 else 0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/IN_DATETIME)!=0) then -1 else 0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
						Event.sendEvent(oldPlantSummaryEvent);
						System.debugOut("Delivery changed by SAP is updated in the Order concept and summary is updated accordingly.");
						
						//Update the date in Order Concept.
						order.DELIVERY_DATE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Delivery_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						order.SHIP_DATE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						
						//Increment the counts in the plantsummary concept with new ShipDate
						System.debugOut("Triggered Plant Summary Event DelDate Changed");
						Events.Internal.PlantSummaryEvent newPlantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then 1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/HH) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then 1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$manual) then 1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($etmGoa_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"$order/CASES\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/ORD_TYPE=$globalVariables/OrderType/HH or $order/ORD_TYPE=$manual) and ($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($sap_SysState/SLA)!=0) and ($sap_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/IN_DATETIME)!=0) then 1 else 0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/OUT_DATETIME)!=0) then 1 else 0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE!=$globalVariables/OrderType/CANCELLED_ORDER and string-length($sap_SysState/OUT_DATETIME)!=0) then 1 else 0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH  and string-length($sap_SysState/OUT_DATETIME)!=0) then 1 else 0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/CANCELLED_ORDER) then 1 else 0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/IN_DATETIME)!=0) then 1 else 0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
						//Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then 1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0 and ($order/ORD_TYPE=$globalVariables/OrderType/HH)) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$manual) then 1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($sap_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($pwm_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($etmGoa_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"$order/CASES\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/ORD_TYPE=$globalVariables/OrderType/HH or $order/ORD_TYPE=$manual) and ($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($sap_SysState/SLA)!=0) and ($sap_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
						Event.sendEvent(newPlantSummaryEvent);
						
					}
					else if((incoming_OrdNum!=order.LGCY_ORD_NUM) && (incoming_SapOutTime>existing_SapOutTime))
					{
						Concepts.ORDERS newOrder=Instance.createInstance("xslt://{{/Concepts/ORDERS}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                    <xsl:attribute name=\"extId\">\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                    </xsl:attribute>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/DELIVERY_DATE\">\n                    <DELIVERY_DATE>\n                        <xsl:value-of select=\"$order/DELIVERY_DATE\"/>\n                    </DELIVERY_DATE>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                    <LGCY_ORD_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                    </LGCY_ORD_NUM>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Sap_Ord_Num\">\n                    <SAP_ORD_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Sap_Ord_Num\"/>\n                    </SAP_ORD_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/LGCY_ORD_NUM\">\n                    <OLD_LGCY_ORD_NUM>\n                        <xsl:value-of select=\"$order/LGCY_ORD_NUM\"/>\n                    </OLD_LGCY_ORD_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/ROUTE_NUM\">\n                    <ROUTE_NUM>\n                        <xsl:value-of select=\"$order/ROUTE_NUM\"/>\n                    </ROUTE_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/ORD_TYPE\">\n                    <ORD_TYPE>\n                        <xsl:value-of select=\"$order/ORD_TYPE\"/>\n                    </ORD_TYPE>\n                </xsl:if>\n                <xsl:if test=\"$order/CUST_NUM\">\n                    <CUST_NUM>\n                        <xsl:value-of select=\"$order/CUST_NUM\"/>\n                    </CUST_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/ORD_CREATIONTIME\">\n                    <ORD_CREATIONTIME>\n                        <xsl:value-of select=\"$order/ORD_CREATIONTIME\"/>\n                    </ORD_CREATIONTIME>\n                </xsl:if>\n                <xsl:if test=\"$order/DELAYED_ORD\">\n                    <DELAYED_ORD>\n                        <xsl:value-of select=\"$order/DELAYED_ORD\"/>\n                    </DELAYED_ORD>\n                </xsl:if>\n                <xsl:if test=\"$order/CASES\">\n                    <CASES>\n                        <xsl:value-of select=\"$order/CASES\"/>\n                    </CASES>\n                </xsl:if>\n                <xsl:if test=\"$order/ORD_STATUS\">\n                    <ORD_STATUS>\n                        <xsl:value-of select=\"$order/ORD_STATUS\"/>\n                    </ORD_STATUS>\n                </xsl:if>\n                <xsl:if test=\"$order/WATSSAPSLA\">\n                    <WATSSAPSLA>\n                        <xsl:value-of select=\"$order/WATSSAPSLA\"/>\n                    </WATSSAPSLA>\n                </xsl:if>\n                <xsl:if test=\"$order/SAPETMSLA\">\n                    <SAPETMSLA>\n                        <xsl:value-of select=\"$order/SAPETMSLA\"/>\n                    </SAPETMSLA>\n                </xsl:if>\n                <xsl:if test=\"$order/SAP_RECEIVED\">\n                    <SAP_RECEIVED>\n                        <xsl:value-of select=\"$order/SAP_RECEIVED\"/>\n                    </SAP_RECEIVED>\n                </xsl:if>\n                <xsl:if test=\"$order/LAST_KNOWN_SYS\">\n                    <LAST_KNOWN_SYS>\n                        <xsl:value-of select=\"$order/LAST_KNOWN_SYS\"/>\n                    </LAST_KNOWN_SYS>\n                </xsl:if>\n                <xsl:if test=\"$order/LAST_KNOWN_TIME\">\n                    <LAST_KNOWN_TIME>\n                        <xsl:value-of select=\"$order/LAST_KNOWN_TIME\"/>\n                    </LAST_KNOWN_TIME>\n                </xsl:if>\n                <xsl:if test=\"$order/TRIPID\">\n                    <TRIPID>\n                        <xsl:value-of select=\"$order/TRIPID\"/>\n                    </TRIPID>\n                </xsl:if>\n                <xsl:if test=\"$order/TRIP_STATUS\">\n                    <TRIP_STATUS>\n                        <xsl:value-of select=\"$order/TRIP_STATUS\"/>\n                    </TRIP_STATUS>\n                </xsl:if>\n                <xsl:if test=\"exists($order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SYSTEM)\">\n                    <SYSSTATE>\n                        <xsl:attribute name=\"extId\">\n                            <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/WATS,$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num)\"/>\n                        </xsl:attribute>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SEQUENCE\">\n                            <SEQUENCE>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SEQUENCE\"/>\n                            </SEQUENCE>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SYSTEM\">\n                            <SYSTEM>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SYSTEM\"/>\n                            </SYSTEM>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/IN_DATETIME\">\n                            <IN_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/IN_DATETIME\"/>\n                            </IN_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/OUT_DATETIME\">\n                            <OUT_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/OUT_DATETIME\"/>\n                            </OUT_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SLA\">\n                            <SLA>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/WATS]/SLA\"/>\n                            </SLA>\n                        </xsl:if>\n                        <LGCY_ORD_NUM>\n                            <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                        </LGCY_ORD_NUM>\n                    </SYSSTATE>\n                </xsl:if>\n                <xsl:if test=\"exists($order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SYSTEM)\">\n                    <SYSSTATE>\n                        <xsl:attribute name=\"extId\">\n                            <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/SAP,$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num)\"/>\n                        </xsl:attribute>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SEQUENCE\">\n                            <SEQUENCE>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SEQUENCE\"/>\n                            </SEQUENCE>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SYSTEM\">\n                            <SYSTEM>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SYSTEM\"/>\n                            </SYSTEM>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/IN_DATETIME\">\n                            <IN_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/IN_DATETIME\"/>\n                            </IN_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/OUT_DATETIME\">\n                            <OUT_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/OUT_DATETIME\"/>\n                            </OUT_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SLA\">\n                            <SLA>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/SAP]/SLA\"/>\n                            </SLA>\n                        </xsl:if>\n                        <LGCY_ORD_NUM>\n                            <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                        </LGCY_ORD_NUM>\n                    </SYSSTATE>\n                </xsl:if>\n                <xsl:if test=\"exists($order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SYSTEM)\">\n                    <SYSSTATE>\n                        <xsl:attribute name=\"extId\">\n                            <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/PWM,$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num)\"/>\n                        </xsl:attribute>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SEQUENCE\">\n                            <SEQUENCE>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SEQUENCE\"/>\n                            </SEQUENCE>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SYSTEM\">\n                            <SYSTEM>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SYSTEM\"/>\n                            </SYSTEM>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/IN_DATETIME\">\n                            <IN_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/IN_DATETIME\"/>\n                            </IN_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/OUT_DATETIME\">\n                            <OUT_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/OUT_DATETIME\"/>\n                            </OUT_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SLA\">\n                            <SLA>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/PWM]/SLA\"/>\n                            </SLA>\n                        </xsl:if>\n                        <LGCY_ORD_NUM>\n                            <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                        </LGCY_ORD_NUM>\n                    </SYSSTATE>\n                </xsl:if>\n                <xsl:if test=\"exists($order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SYSTEM)\">\n                    <SYSSTATE>\n                        <xsl:attribute name=\"extId\">\n                            <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/ETM-GOA,$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num)\"/>\n                        </xsl:attribute>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SEQUENCE\">\n                            <SEQUENCE>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SEQUENCE\"/>\n                            </SEQUENCE>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SYSTEM\">\n                            <SYSTEM>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SYSTEM\"/>\n                            </SYSTEM>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/IN_DATETIME\">\n                            <IN_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/IN_DATETIME\"/>\n                            </IN_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/OUT_DATETIME\">\n                            <OUT_DATETIME>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/OUT_DATETIME\"/>\n                            </OUT_DATETIME>\n                        </xsl:if>\n                        <xsl:if test=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SLA\">\n                            <SLA>\n                                <xsl:value-of select=\"$order/SYSSTATE[SYSTEM=$globalVariables/OrderSystems/ActualSystems/ETM-GOA]/SLA\"/>\n                            </SLA>\n                        </xsl:if>\n                        <LGCY_ORD_NUM>\n                            <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                        </LGCY_ORD_NUM>\n                    </SYSSTATE>\n                </xsl:if>\n                <xsl:if test=\"$order/E2ESLA\">\n                    <E2ESLA>\n                        <xsl:value-of select=\"$order/E2ESLA\"/>\n                    </E2ESLA>\n                </xsl:if>\n                <xsl:if test=\"$order/CANCELLED_ORDER\">\n                    <CANCELLED_ORDER>\n                        <xsl:value-of select=\"$order/CANCELLED_ORDER\"/>\n                    </CANCELLED_ORDER>\n                </xsl:if>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
						Instance.deleteInstance(order);
						System.debugOut("SAPOUT 2nd iteration: Created Order with Order with New_Lgcy_Ord_Num, copied the existing order data and deleted the same.");
						//Consuming/Deleting orderEvent.
					}
					else if(order.LGCY_ORD_NUM==incoming_OrdNum)
					{
						System.debugOut("This Order is already sent by SAP");
						//Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"&quot;ORDER&quot;\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$order/PLANT_NUM\">\n                                <ns:TransactionID>\n                                    <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                                </ns:TransactionID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/OrderAlreadyExists/code\"/>\n                        </ns:Code>\n                        <ns:Message>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/OrderAlreadyExists/message\"/>\n                        </ns:Message>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($orderEvent/payload)\"/>\n                        </ns:TransactionData>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
					}
					else
					{
						order.OLD_LGCY_ORD_NUM=incoming_OrdNum;
						System.debugOut("SAPOUT 1st iteration received after second iteration: hence, ignoring the order Event");
						//Consuming/Deleting orderEvent.
					}
				}
				else
				{
					
					//############################Checking if DeliveryDate of the Order is changed by SAP############################
					if(order.DELIVERY_DATE!=sap_DelDate)
					{
						if(wats_SysState!=null)
						{
							Events.Internal.PlantSummaryEvent plantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then -1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH) then -1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then -1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH and string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH and string-length($sap_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($order/E2ESLA)!=0 and ($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL) ) &#xA;then -1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SLA)!=0 and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL) ) &#xA;then -1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH and string-length($wats_SysState/IN_DATETIME)!=0) then -1 else 0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $order/ORD_TYPE=$globalVariables/OrderType/HH and string-length($wats_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							Event.sendEvent(plantSummaryEvent);
							System.debugOut("Delivery changed by SAP is updated in the Order concept and summary is updated accordingly.");
							order.DELIVERY_DATE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Delivery_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
							order.SHIP_DATE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
							delDate_Changed=true;
						
						}
					}	
					
					//############################Check if SAP IN is received############################
					if(sap_SysState!=null)
					{
						long sapInTime=DateTime.getTimeInMillis(XPath.evalAsDateTime("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>tib:parse-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", $sap_SysState/IN_DATETIME)</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>sap_SysState</variable>\n    </variables>\n</xpath>"));
						long actualDelay=incoming_SapOutTime-sapInTime;
						long expectedLateDelay=System.getGlobalVariableAsLong("SLA/INTERVAL/SAP_SLA",10000);
						
						if(actualDelay<=expectedLateDelay)
						{
							sapSLA=System.getGlobalVariableAsString("SLA/STATUS/SUCCESS","PASS");
						}
						else
						{
							sapSLA=System.getGlobalVariableAsString("SLA/STATUS/SECONDFAIL","FAIL");
						}
						System.debugOut("Calculated SAP system SLA and set the status = "+sapSLA);
						
					}
					
					
					//############################Calculating E2ESLA of manual Orders. Check if required?############################
					if(ordType==manual)
					{
						//Check if ETM-GOAIN event is received for the Order
						if(etmGoa_SysState!=null && etmGoa_SysState.IN_DATETIME!=null)
						{
							//Calculate E2E delay and set the E2ESLA status.
							long etmGoaInTime=DateTime.getTimeInMillis(XPath.evalAsDateTime("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>tib:parse-dateTime(\"MM-dd-yyyy HH:mm:ss.SSS\", $etmGoa_SysState/IN_DATETIME)</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>etmGoa_SysState</variable>\n    </variables>\n</xpath>"));
							long actualDelay=etmGoaInTime-incoming_SapOutTime;
							long expectedDelay=System.getGlobalVariableAsLong("SLA/INTERVAL/ORDER_E2ESLA",30000);
							
							if(actualDelay>expectedDelay)
							{
								e2eSLA=System.getGlobalVariableAsString("SLA/STATUS/SECONDFAIL","FAIL");
							}
							else
							{
								e2eSLA=System.getGlobalVariableAsString("SLA/STATUS/SUCCESS","PASS");
							}
							System.debugOut("Calculated E2E delay and set the E2ESLA status = "+e2eSLA);			
						}
						else
						{	//Trigger E2ESLA timer if order_type is manual.
							String schedulerName=System.getGlobalVariableAsString("Scheduler/SchedulerName","GESScheduler");
							String system=System.getGlobalVariableAsString("OrderSystems/InputSystems/SAPOUT","SAPOUT");
							String subWorkKey=String.concat(system,order.LGCY_ORD_NUM);
						
							String workKeyE2ESLA=subWorkKey+"E2ESLA";
							Events.Timer.SLATimerEvent sapE2ESlaTimerEvent=Event.createEvent("xslt://{{/Events/Timer/SLATimerEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"workKeyE2ESLA\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$workKeyE2ESLA\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/LGCY_ORD_NUM\">\n                    <Ord_Num>\n                        <xsl:value-of select=\"$order/LGCY_ORD_NUM\"/>\n                    </Ord_Num>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:System\">\n                    <System>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:System\"/>\n                    </System>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                    <Plant_Num>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                    </Plant_Num>\n                </xsl:if>\n                <Interval>\n                    <xsl:value-of select=\"$globalVariables/SLA/INTERVAL/MANUAL_E2ESLA\"/>\n                </Interval>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							Long E2ESLAInterval=System.currentTimeMillis() + System.getGlobalVariableAsLong("SLA/INTERVAL/MANUAL_E2ESLA",25000);
							Cluster.scheduleEvent(schedulerName,workKeyE2ESLA,sapE2ESlaTimerEvent,E2ESLAInterval);
							System.debugOut("Triggered E2ESLA timer as order_type is manual");
						}
					}
					else if(ordType==cancelled)//set E2ESLA to PASS incase of Cancelled orders.
					{
						e2eSLA=System.getGlobalVariableAsString("SLA/STATUS/SUCCESS","PASS");
						order.CANCELLED_ORDER=true;
						order.ORD_TYPE = cancelled;
					}
						
					//############################Trigger Plant Summary Event############################
					{	
						order.SHIP_DATE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						if(delDate_Changed)
						{
							System.debugOut("Triggered Plant Summary Event DelDate Changed");
							Events.Internal.PlantSummaryEvent plantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:param name=\"e2eSLA\"/>\n    <xsl:param name=\"sapSLA\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Ship_Date\"/>\n                </SHIP_DATE>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then 1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then 1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($orderEvent/payload/ns:ORDER/ns:Ord_Type=$manual) then 1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($etmGoa_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </GOA_ORD_CNT>\n                <xsl:if test=\"$order/CASES\">\n                    <TOTAL_CASES_CNT>\n                        <xsl:value-of select=\"$order/CASES\"/>\n                    </TOTAL_CASES_CNT>\n                </xsl:if>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if($e2eSLA=$globalVariables/SLA/STATUS/SECONDFAIL) then 1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if($sapSLA=$globalVariables/SLA/STATUS/SECONDFAIL) then 0 else 1\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/IN_DATETIME)!=0) then 1 else 0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/OUT_DATETIME)!=0) then 1 else 0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/CANCELLED_ORDER) then 0 else 1\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/HH) then 1 else 0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/CANCELLED_ORDER) then 1 else 0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/IN_DATETIME)!=0) then 1 else 0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							Event.sendEvent(plantSummaryEvent);
						}
						else if(order.CANCELLED_ORDER)
						{
							System.debugOut("Triggered Plant Summary Event CANCELLED_ORDER");
							Events.Internal.PlantSummaryEvent plantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"e2eSLA\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then -1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;true&quot;) then -1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($sap_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if($e2eSLA=$globalVariables/SLA/STATUS/SECONDFAIL) then -1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SLA)!=0 and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL) ) &#xA;then -1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/CANCELLED_ORDER) then 1 else 0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							//Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:param name=\"sapSLA\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Ship_Date\"/>\n                </SHIP_DATE>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/OUT_DATETIME)!=0) then -1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($pwm_SysState/SYSTEM)!=0 and string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($etmGoa_SysState/SYSTEM)!=0 and string-length($wats_SysState/SYSTEM)!=0) then -1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"if(string-length($etmGoa_SysState/SYSTEM)!=0 and string-length($wats_SysState/SYSTEM)!=0) then 0-$order/CASES  else 0\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL) or ($order/E2ESLA=$globalVariables/SLA/STATUS/FIRSTFAIL)) then -1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and &#xA;(($wats_SysState/SLA!=$globalVariables/SLA/STATUS/INITIAL) or($wats_SysState/SLA!=$globalVariables/SLA/STATUS/SUCCESS)))&#xA; then -1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if (($sapSLA=$globalVariables/SLA/STATUS/SUCCESS) or ($sapSLA=$globalVariables/SLA/STATUS/INITIAL)) &#xA;then 0 &#xA;else -1\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and &#xA;(($pwm_SysState/SLA!=$globalVariables/SLA/STATUS/INITIAL) or($pwm_SysState/SLA!=$globalVariables/SLA/STATUS/SUCCESS)))&#xA; then -1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							Event.sendEvent(plantSummaryEvent);
						}
						else
						{
							System.debugOut("Triggered Plant Summary Event");
							Events.Internal.PlantSummaryEvent plantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"ordType\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:param name=\"e2eSLA\"/>\n    <xsl:param name=\"sapSLA\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                </SHIP_DATE>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)=0  and ($ordType=$globalVariables/OrderType/HH) ) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($ordType=$manual) then 1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($sap_SysState/SYSTEM)=0) then 1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($pwm_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($etmGoa_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </GOA_ORD_CNT>\n                <xsl:if test=\"$order/CASES\">\n                    <TOTAL_CASES_CNT>\n                        <xsl:value-of select=\"$order/CASES\"/>\n                    </TOTAL_CASES_CNT>\n                </xsl:if>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$globalVariables/OrderType/MANUAL and $e2eSLA=$globalVariables/SLA/STATUS/SECONDFAIL) then 1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if ($sapSLA=$globalVariables/SLA/STATUS/SECONDFAIL) then 1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if(string-length($pwm_SysState/SLA)!=0 and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL)) then 1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type!=$globalVariables/OrderType/CANCELLED_ORDER) then 1 else 0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/HH) then 1 else 0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and $orderEvent/payload/ns:ORDER/ns:Ord_Type=$globalVariables/OrderType/CANCELLED_ORDER) then 1 else 0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"if($order/DELAYED_ORD=&quot;false&quot; and string-length($pwm_SysState/IN_DATETIME)!=0 ) then 1 else 0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							//Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"wats_SysState\"/>\n    <xsl:param name=\"manual\"/>\n    <xsl:param name=\"pwm_SysState\"/>\n    <xsl:param name=\"etmGoa_SysState\"/>\n    <xsl:param name=\"sap_SysState\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderEvent/payload/ns:ORDER/ns:JMSDateTime)\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$order/PLANT_NUM\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <xsl:if test=\"$order/PLANT_NAME\">\n                    <PLANT_NAME>\n                        <xsl:value-of select=\"$order/PLANT_NAME\"/>\n                    </PLANT_NAME>\n                </xsl:if>\n                <xsl:if test=\"$order/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$order/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"if($order/TRIP_STATUS=&quot;true&quot;) then 1 else 0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0 and ($order/ORD_TYPE=$globalVariables/OrderType/HH)) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"if($order/ORD_TYPE=$manual) then 1 else 0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($wats_SysState/OUT_DATETIME)!=0) then 1 else 0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($pwm_SysState/SYSTEM)!=0) then 1 else 0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"if(string-length($etmGoa_SysState/SYSTEM)!=0 ) then 1 else 0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"$order/CASES\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"if(($order/ORD_TYPE=$globalVariables/OrderType/HH or $order/ORD_TYPE=$manual) and ($order/E2ESLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($wats_SysState/SLA)!=0) and ($wats_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($sap_SysState/SLA)!=0) and ($sap_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"if((string-length($pwm_SysState/SLA)!=0) and ($pwm_SysState/SLA=$globalVariables/SLA/STATUS/SECONDFAIL))&#xA; then 1 else 0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
							Event.sendEvent(plantSummaryEvent);
						}
						
					}
					
					//############################Update the Order concept############################
					{
						//Updating sap_SysState.
						if(sap_SysState!=null)
						{
							int sapIndex=Instance.PropertyArray.indexOfContainedConcept(order.SYSSTATE,sap_SysState);
							order.SYSSTATE[sapIndex].OUT_DATETIME=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:JMSDateTime</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
							order.SYSSTATE[sapIndex].SLA=sapSLA;
						}
						else
						{
							//Creating SysState concept instance.
							sap_SysState=Instance.createInstance("xslt://{{/Concepts/ORDER_SYSSTATE}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"sapSLA\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/SAP,$order/LGCY_ORD_NUM)\"/>\n                </xsl:attribute>\n                <SEQUENCE>\n                    <xsl:value-of select=\"$globalVariables/OrderSystems/SystemSequence/SAP\"/>\n                </SEQUENCE>\n                <SYSTEM>\n                    <xsl:value-of select=\"$globalVariables/OrderSystems/ActualSystems/SAP\"/>\n                </SYSTEM>\n                <OUT_DATETIME>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\"/>\n                </OUT_DATETIME>\n                <SLA>\n                    <xsl:value-of select=\"$sapSLA\"/>\n                </SLA>\n                <LGCY_ORD_NUM>\n                    <xsl:value-of select=\"$order/LGCY_ORD_NUM\"/>\n                </LGCY_ORD_NUM>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
							Instance.PropertyArray.appendContainedConcept(order.SYSSTATE,sap_SysState,DateTime.getTimeInMillis(DateTime.now()));
						}
	
						order.E2ESLA=e2eSLA;
						order.SAP_RECEIVED=true;
						order.ROUTE_NUM=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Route_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						order.CUST_NUM=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:CustNum</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");						
						order.SAP_ORD_NUM=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Sap_Ord_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						order.ORD_TYPE=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ord_Type</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						if(order.LAST_KNOWN_SYS==wats)
						{
							order.LAST_KNOWN_SYS=sap;
							order.LAST_KNOWN_TIME=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:JMSDateTime</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
						}
					}		
				}
			}
		}
		catch(Exception e)
		{
			String message="Exception caught in processing SAPOUTOrderUpdation rule ";
			System.debugOut(message+e);
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"message\"/>\n    <xsl:param name=\"order\"/>\n    <xsl:param name=\"e\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns:ComponentName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"$message\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$order/PLANT_NUM\">\n                                <ns:BusinessID>\n                                    <xsl:value-of select=\"$order/PLANT_NUM\"/>\n                                </ns:BusinessID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$e/@errorType\"/>\n                        </ns:Code>\n                        <xsl:if test=\"$e/@message\">\n                            <ns:Message>\n                                <xsl:value-of select=\"$e/@message\"/>\n                            </ns:Message>\n                        </xsl:if>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($orderEvent/payload)\"/>\n                        </ns:TransactionData>\n                        <ns:DumpAnalysis>\n                            <xsl:value-of select=\"string($e)\"/>\n                        </ns:DumpAnalysis>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
			
		finally
		{
			//Logging.
			if(cleFlag)
			{
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_TransactionType/OrderFlow\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                                <ns1:TransactionID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                                </ns1:TransactionID>\n                            </xsl:if>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Completed processing Order Event at &quot;,$orderEvent/payload/ns:ORDER/ns:System)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;End Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($orderEvent)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			
			//############################Consuming/Deleting orderEvent############################
			Event.consumeEvent(orderEvent);
		}	
		
	}
}