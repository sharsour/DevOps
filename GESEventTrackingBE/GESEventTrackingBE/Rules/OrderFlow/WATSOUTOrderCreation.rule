/**
 * @description This rule creates the Order concept with the data of incoming WATS OUT Order Event.
 * @author HYDPCM228839D
 */
rule Rules.OrderFlow.WATSOUTOrderCreation {
	attribute {
		priority = 2;
		forwardChain = true;
	}
	declare {
		Events.Input.OrderEvent	orderEvent;
		Concepts.PLANT_TIMEZONE plantTZ;
		
	}
	when {
		//Check the System Name
		System.getGlobalVariableAsString("OrderSystems/InputSystems/WATSOUT-SAPIN","WATSOUT")==XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:System</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
		
	}
	then {
		System.debugOut("In WATS OUT Order Creation rule");
		
		//Logging.
		boolean cleFlag=System.getGlobalVariableAsBoolean("CLEparams/CLE_Flag",true);
		String gesAgentId=Engine.engineName();
		if(cleFlag)
		{
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_TransactionType/OrderFlow\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                                <ns1:TransactionID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                                </ns1:TransactionID>\n                            </xsl:if>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Started processing Order Event at &quot;,$orderEvent/payload/ns:ORDER/ns:System)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;Start Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($orderEvent)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
		
		try
		{
			//Checking if ShipDate is empty.
			String shipDate=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
			if(shipDate==null)
			{
				System.debugOut("Empty ShipDate");
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns1=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"&quot;ORDER&quot;\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns1:ORDER/ns1:Plant_Num\">\n                                <ns:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns1:ORDER/ns1:Plant_Num\"/>\n                                </ns:BusinessID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/InvalidShipDate/code\"/>\n                        </ns:Code>\n                        <ns:Message>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/ErrorCodes/InvalidShipDate/message\"/>\n                        </ns:Message>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($orderEvent/payload)\"/>\n                        </ns:TransactionData>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			else
			{
				//Retrieve Plant Name by using Plant Number from Order Event.
				String plantNum=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Plant_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
				String plantName=RuleFunctions.Inference.CommonRF.getPlantName(plantNum/*plantNum String */,plantTZ/*plantTZ Concepts.PLANT_TIMEZONE */);
				
				//Check if WATS OUT is received after DRF event is received and PWMIN/PWMOUT/SAPOUT is not received
				String ordNum=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Lgcy_Ord_Num</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
				String ordReNumExtId=System.getGlobalVariableAsString("EXTIDS/ORD_RE_NUM","ORD_RE_NUM");
				Concepts.ORDER_RE_NUM ordReNum=Instance.getByExtIdByUri(ordReNumExtId,"/Concepts/ORDER_RE_NUM");
				String new_Lgcy_Ord_Num=RuleFunctions.Inference.OrderFlowRF.getRenumberedOrder(ordNum/*OrdID String */,"NEW"/*Type String */,ordReNum/*ordReNum Concepts.ORDER_RE_NUM */);
				String sap_Ord_Num=RuleFunctions.Inference.OrderFlowRF.getRenumberedOrder(ordNum/*OrdID String */,"SAP"/*Type String */,ordReNum/*ordReNum Concepts.ORDER_RE_NUM */);
				Concepts.ORDERS orderInstance;
				
				
				//Check if Order is delayed Order.
				long ordLockTime=RuleFunctions.Inference.OrderFlowRF.getOrderLockTime(plantNum/*plantNum String */,XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:Ship_Date</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.tibco.com/bw/xslt/custom-functions\" pfx=\"tib\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>")/*ShipDate String */);
				long orderCreationTime=XPath.evalAsLong("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$orderEvent/payload/xsd2:ORDER/xsd2:OrderCreateTime</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n    </namespaces>\n    <variables>\n        <variable>orderEvent</variable>\n    </variables>\n</xpath>");
				boolean delayedOrder=false;
				if((ordLockTime!=0) && (orderCreationTime>ordLockTime))
				{
					delayedOrder=true;
				}
						
				//Creating Order concept instance.
				if(new_Lgcy_Ord_Num==null)
				{
					orderInstance=Instance.createInstance("xslt://{{/Concepts/ORDERS}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"delayedOrder\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <DELIVERY_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Delivery_Date\"/>\n                </DELIVERY_DATE>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Ship_Date\"/>\n                </SHIP_DATE>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                    <LGCY_ORD_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                    </LGCY_ORD_NUM>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Route_Num\">\n                    <ROUTE_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Route_Num\"/>\n                    </ROUTE_NUM>\n                </xsl:if>\n                <ORD_TYPE>\n                    <xsl:value-of select=\"$globalVariables/OrderType/HH\"/>\n                </ORD_TYPE>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:CustNum\">\n                    <CUST_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:CustNum\"/>\n                    </CUST_NUM>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:OrderCreateTime\">\n                    <ORD_CREATIONTIME>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:OrderCreateTime\"/>\n                    </ORD_CREATIONTIME>\n                </xsl:if>\n                <DELAYED_ORD>\n                    <xsl:value-of select=\"$delayedOrder\"/>\n                </DELAYED_ORD>\n                <ORD_STATUS>\n                    <xsl:value-of select=\"false()\"/>\n                </ORD_STATUS>\n                <WATSSAPSLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </WATSSAPSLA>\n                <SAPETMSLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </SAPETMSLA>\n                <SAP_RECEIVED>\n                    <xsl:value-of select=\"false()\"/>\n                </SAP_RECEIVED>\n                <LAST_KNOWN_SYS>\n                    <xsl:value-of select=\"$globalVariables/OrderSystems/ActualSystems/SAP\"/>\n                </LAST_KNOWN_SYS>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\">\n                    <LAST_KNOWN_TIME>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\"/>\n                    </LAST_KNOWN_TIME>\n                </xsl:if>\n                <TRIP_STATUS>\n                    <xsl:value-of select=\"false()\"/>\n                </TRIP_STATUS>\n                <SYSSTATE>\n                    <xsl:attribute name=\"extId\">\n                        <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/WATS,$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num )\"/>\n                    </xsl:attribute>\n                    <SEQUENCE>\n                        <xsl:value-of select=\"$globalVariables/OrderSystems/SystemSequence/WATS\"/>\n                    </SEQUENCE>\n                    <SYSTEM>\n                        <xsl:value-of select=\"$globalVariables/OrderSystems/ActualSystems/WATS\"/>\n                    </SYSTEM>\n                    <OUT_DATETIME>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\"/>\n                    </OUT_DATETIME>\n                    <SLA>\n                        <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                    </SLA>\n                    <LGCY_ORD_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                    </LGCY_ORD_NUM>\n                </SYSSTATE>\n                <E2ESLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </E2ESLA>\n                <CANCELLED_ORDER>\n                    <xsl:value-of select=\"false()\"/>\n                </CANCELLED_ORDER>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				else
				{
					orderInstance=Instance.createInstance("xslt://{{/Concepts/ORDERS}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"new_Lgcy_Ord_Num\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"sap_Ord_Num\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"delayedOrder\"/>\n    <xsl:template match=\"/\">\n        <createObject>\n            <object>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$new_Lgcy_Ord_Num\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                    <PLANT_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                    </PLANT_NUM>\n                </xsl:if>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <DELIVERY_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Delivery_Date\"/>\n                </DELIVERY_DATE>\n                <SHIP_DATE>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Ship_Date\"/>\n                </SHIP_DATE>\n                <LGCY_ORD_NUM>\n                    <xsl:value-of select=\"$new_Lgcy_Ord_Num\"/>\n                </LGCY_ORD_NUM>\n                <SAP_ORD_NUM>\n                    <xsl:value-of select=\"$sap_Ord_Num\"/>\n                </SAP_ORD_NUM>\n                <OLD_LGCY_ORD_NUM>\n                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                </OLD_LGCY_ORD_NUM>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Route_Num\">\n                    <ROUTE_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Route_Num\"/>\n                    </ROUTE_NUM>\n                </xsl:if>\n                <ORD_TYPE>\n                    <xsl:value-of select=\"$globalVariables/OrderType/HH\"/>\n                </ORD_TYPE>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:CustNum\">\n                    <CUST_NUM>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:CustNum\"/>\n                    </CUST_NUM>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:OrderCreateTime\">\n                    <ORD_CREATIONTIME>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:OrderCreateTime\"/>\n                    </ORD_CREATIONTIME>\n                </xsl:if>\n                <DELAYED_ORD>\n                    <xsl:value-of select=\"$delayedOrder\"/>\n                </DELAYED_ORD>\n                <ORD_STATUS>\n                    <xsl:value-of select=\"false()\"/>\n                </ORD_STATUS>\n                <WATSSAPSLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </WATSSAPSLA>\n                <SAPETMSLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </SAPETMSLA>\n                <SAP_RECEIVED>\n                    <xsl:value-of select=\"false()\"/>\n                </SAP_RECEIVED>\n                <xsl:if test=\"$globalVariables/OrderSystems/ActualSystems/SAP\">\n                    <LAST_KNOWN_SYS>\n                        <xsl:value-of select=\"$globalVariables/OrderSystems/ActualSystems/SAP\"/>\n                    </LAST_KNOWN_SYS>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\">\n                    <LAST_KNOWN_TIME>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\"/>\n                    </LAST_KNOWN_TIME>\n                </xsl:if>\n                <TRIP_STATUS>\n                    <xsl:value-of select=\"false()\"/>\n                </TRIP_STATUS>\n                <SYSSTATE>\n                    <xsl:attribute name=\"extId\">\n                        <xsl:value-of select=\"concat($globalVariables/OrderSystems/ActualSystems/WATS,$new_Lgcy_Ord_Num)\"/>\n                    </xsl:attribute>\n                    <SEQUENCE>\n                        <xsl:value-of select=\"$globalVariables/OrderSystems/SystemSequence/WATS\"/>\n                    </SEQUENCE>\n                    <SYSTEM>\n                        <xsl:value-of select=\"$globalVariables/OrderSystems/ActualSystems/WATS\"/>\n                    </SYSTEM>\n                    <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\">\n                        <IN_DATETIME>\n                            <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:JMSDateTime\"/>\n                        </IN_DATETIME>\n                    </xsl:if>\n                    <SLA>\n                        <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                    </SLA>\n                    <LGCY_ORD_NUM>\n                        <xsl:value-of select=\"$new_Lgcy_Ord_Num\"/>\n                    </LGCY_ORD_NUM>\n                </SYSSTATE>\n                <E2ESLA>\n                    <xsl:value-of select=\"$globalVariables/SLA/STATUS/INITIAL\"/>\n                </E2ESLA>\n                <CANCELLED_ORDER>\n                    <xsl:value-of select=\"false()\"/>\n                </CANCELLED_ORDER>\n            </object>\n        </createObject>\n    </xsl:template>\n</xsl:stylesheet>");
				}
				
				//Schedule Timer Events to check SAPETM SLAs.
				String schedulerName=System.getGlobalVariableAsString("Scheduler/SchedulerName","GESScheduler");
				String system=System.getGlobalVariableAsString("OrderSystems/InputSystems/WATSOUT-SAPIN","WATSOUT");
				String subWorkKey=String.concat(system,orderInstance.LGCY_ORD_NUM);
				
				//Timer Event to check if SAPETM Status is LATE.
				String workKeyLate=subWorkKey+"LATE";
				Events.Timer.SLATimerEvent watsSlaLateTimerEvent=Event.createEvent("xslt://{{/Events/Timer/SLATimerEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"workKeyLate\"/>\n    <xsl:param name=\"orderInstance\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$workKeyLate\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$orderInstance/LGCY_ORD_NUM\">\n                    <Ord_Num>\n                        <xsl:value-of select=\"$orderInstance/LGCY_ORD_NUM\"/>\n                    </Ord_Num>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:System\">\n                    <System>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:System\"/>\n                    </System>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                    <Plant_Num>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                    </Plant_Num>\n                </xsl:if>\n                <Interval>\n                    <xsl:value-of select=\"$globalVariables/SLA/INTERVAL/SAPETMLATE\"/>\n                </Interval>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Long lateInterval=System.currentTimeMillis() + System.getGlobalVariableAsLong("SLA/INTERVAL/SAPETMLATE",20000);
				Cluster.scheduleEvent(schedulerName,workKeyLate,watsSlaLateTimerEvent,lateInterval);
				
				//Timer Event to check if SAPETM Status is FAIL.
				String workKeyFail=subWorkKey+"FAIL";
				Events.Timer.SLATimerEvent watsSlaFailTimerEvent=Event.createEvent("xslt://{{/Events/Timer/SLATimerEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"workKeyFail\"/>\n    <xsl:param name=\"orderInstance\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"$workKeyFail\"/>\n                </xsl:attribute>\n                <xsl:if test=\"$orderInstance/LGCY_ORD_NUM\">\n                    <Ord_Num>\n                        <xsl:value-of select=\"$orderInstance/LGCY_ORD_NUM\"/>\n                    </Ord_Num>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:System\">\n                    <System>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:System\"/>\n                    </System>\n                </xsl:if>\n                <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                    <Plant_Num>\n                        <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                    </Plant_Num>\n                </xsl:if>\n                <Interval>\n                    <xsl:value-of select=\"$globalVariables/SLA/INTERVAL/SAPETMFAIL\"/>\n                </Interval>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Long failInterval=System.currentTimeMillis() + System.getGlobalVariableAsLong("SLA/INTERVAL/SAPETMFAIL",30000);
				Cluster.scheduleEvent(schedulerName,workKeyFail,watsSlaFailTimerEvent,failInterval);
				
				
				//Triggering Summary Event to update PLANT_SUMMARY concept.
				Events.Internal.PlantSummaryEvent plantSummaryEvent=Event.createEvent("xslt://{{/Events/Internal/PlantSummaryEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:tib=\"http://www.tibco.com/bw/xslt/custom-functions\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd tib\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"orderCreationTime\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"plantName\"/>\n    <xsl:param name=\"orderInstance\"/>\n    <xsl:param name=\"delayedOrder\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <xsl:attribute name=\"extId\">\n                    <xsl:value-of select=\"concat($globalVariables/EXTIDS/PLANT_SUMMARY, $orderEvent/payload/ns:ORDER/ns:Plant_Num,$orderCreationTime)\"/>\n                </xsl:attribute>\n                <PLANT_NUM>\n                    <xsl:value-of select=\"$plantNum\"/>\n                </PLANT_NUM>\n                <PLANT_NAME>\n                    <xsl:value-of select=\"$plantName\"/>\n                </PLANT_NAME>\n                <xsl:if test=\"$orderInstance/SHIP_DATE\">\n                    <SHIP_DATE>\n                        <xsl:value-of select=\"$orderInstance/SHIP_DATE\"/>\n                    </SHIP_DATE>\n                </xsl:if>\n                <ORD_TRIPPED_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_TRIPPED_CNT>\n                <ORD_CNT>\n                    <xsl:value-of select=\"if ($delayedOrder=&quot;false&quot;) then 1 else 0\"/>\n                </ORD_CNT>\n                <DELAYED_ORD_CNT>\n                    <xsl:value-of select=\"if ($delayedOrder=&quot;true&quot;) then 1 else 0\"/>\n                </DELAYED_ORD_CNT>\n                <MANUAL_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </MANUAL_ORD_CNT>\n                <WATS_ORD_CNT>\n                    <xsl:value-of select=\"1\"/>\n                </WATS_ORD_CNT>\n                <SAP_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_ORD_CNT>\n                <PWM_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_ORD_CNT>\n                <GOA_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </GOA_ORD_CNT>\n                <TOTAL_CASES_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TOTAL_CASES_CNT>\n                <TM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </TM_TRIP_CNT>\n                <ETM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ETM_TRIP_CNT>\n                <SAP_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_TRIP_CNT>\n                <PWM_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_TRIP_CNT>\n                <E2ESLA_MISS_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_ORD_CNT>\n                <E2ESLA_MISS_TRIP_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </E2ESLA_MISS_TRIP_CNT>\n                <ORD_WATS_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_WATS_SLA_MISS_CNT>\n                <ORD_SAP_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_SAP_SLA_MISS_CNT>\n                <ORD_PWM_SLA_MISS_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </ORD_PWM_SLA_MISS_CNT>\n                <WATS_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </WATS_IN_ORD_CNT>\n                <WATS_OUT_ORD_CNT>\n                    <xsl:value-of select=\"1\"/>\n                </WATS_OUT_ORD_CNT>\n                <SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </SAP_OUT_ORD_CNT>\n                <HH_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </HH_SAP_OUT_ORD_CNT>\n                <CANCELLED_SAP_OUT_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </CANCELLED_SAP_OUT_ORD_CNT>\n                <PWM_IN_ORD_CNT>\n                    <xsl:value-of select=\"0\"/>\n                </PWM_IN_ORD_CNT>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
				Event.sendEvent(plantSummaryEvent);
			}
		}
		catch(Exception e)
		{
			String message="Exception caught in processing WATSOUTOrderCreation rule = ";
			System.debugOut(message+e);
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns1=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"message\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:param name=\"e\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns:ComponentName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"$message\"/>\n                            </ns:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns1:ORDER/ns1:Plant_Num\">\n                                <ns:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns1:ORDER/ns1:Plant_Num\"/>\n                                </ns:BusinessID>\n                            </xsl:if>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$e/@errorType\"/>\n                        </ns:Code>\n                        <xsl:if test=\"$e/@message\">\n                            <ns:Message>\n                                <xsl:value-of select=\"$e/@message\"/>\n                            </ns:Message>\n                        </xsl:if>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($orderEvent/payload)\"/>\n                        </ns:TransactionData>\n                        <ns:DumpAnalysis>\n                            <xsl:value-of select=\"string($e)\"/>\n                        </ns:DumpAnalysis>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
			
		finally
		{		
			//End Logging.
			if(cleFlag)
			{
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"ns1 xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"orderEvent\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/OrderFlow\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_TransactionType/OrderFlow\"/>\n                            </ns1:TransactionType>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\">\n                                <ns1:TransactionID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Lgcy_Ord_Num\"/>\n                                </ns1:TransactionID>\n                            </xsl:if>\n                            <xsl:if test=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\">\n                                <ns1:BusinessID>\n                                    <xsl:value-of select=\"$orderEvent/payload/ns:ORDER/ns:Plant_Num\"/>\n                                </ns1:BusinessID>\n                            </xsl:if>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Completed processing Order Event at &quot;,$orderEvent/payload/ns:ORDER/ns:System)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;End Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($orderEvent)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			
			//Consuming/Deleting the Order Event.
			Event.consumeEvent(orderEvent);
		}
		
	}
}