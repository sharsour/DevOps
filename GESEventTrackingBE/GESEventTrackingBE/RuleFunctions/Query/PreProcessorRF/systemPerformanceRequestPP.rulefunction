/**
 * @description This rule function will check the System Performance at WATS-SAP, SAP-ETM & ETM-PWM systems.
 */
void rulefunction RuleFunctions.Query.PreProcessorRF.systemPerformanceRequestPP {
	attribute {
		validity = ACTION;
	}
	scope {
		Events.Query.SystemPerfRequest SystemPerfRequest;
	}
	body {
		System.debugOut("In SystemPerfRequestPP");
		//Logging.
		boolean cleFlag=System.getGlobalVariableAsBoolean("CLEparams/CLE_Flag",true);
		String gesAgentId=Engine.engineName();
		if(cleFlag)
		{
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns2=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd3\" xmlns:ns3=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd2\" xmlns:ns4=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd4\" xmlns:ns5=\"http://www.tibco.com/schemas/GESEventsMonitoring/SharedResources/SchemaDefinitions/Input/Schema.xsd\" version=\"1.0\" exclude-result-prefixes=\"ns2 ns1 xsl ns4 ns ns3 xsd ns5\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"SystemPerfRequest\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/Query\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"&quot;SYSTEM PERFORMANCE&quot;\"/>\n                            </ns1:TransactionType>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Querying System performance of PlantNum =  &quot;,$SystemPerfRequest/payload/ns:SystemPerformanceRequest/ns:SysPerfRequest/ns:PlantNum,&quot; on &quot;, $SystemPerfRequest/payload/ns:SystemPerformanceRequest/ns:SysPerfRequest/ns:ShipDate)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;Start Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($SystemPerfRequest)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
		
		try
		{
			String plantNum=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$SystemPerfRequest/payload/xsd3:SystemPerformanceRequest/xsd3:SysPerfRequest/xsd3:PlantNum</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.tibco.com/schemas/GESEventsMonitoring/SharedResources/SchemaDefinitions/Input/Schema.xsd\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd3\"/>\n    </namespaces>\n    <variables>\n        <variable>SystemPerfRequest</variable>\n    </variables>\n</xpath>");
			String shipDate=XPath.evalAsString("xpath://<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xpath>\n    <expr>$SystemPerfRequest/payload/xsd3:SystemPerformanceRequest/xsd3:SysPerfRequest/xsd3:ShipDate</expr>\n    <namespaces>\n        <namespace URI=\"http://www.w3.org/1999/XSL/Transform\" pfx=\"xsl\"/>\n        <namespace URI=\"http://www.tibco.com/schemas/GESEventsMonitoring/SharedResources/SchemaDefinitions/Input/Schema.xsd\" pfx=\"xsd2\"/>\n        <namespace URI=\"http://www.w3.org/2001/XMLSchema\" pfx=\"xsd\"/>\n        <namespace URI=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" pfx=\"xsd3\"/>\n    </namespaces>\n    <variables>\n        <variable>SystemPerfRequest</variable>\n    </variables>\n</xpath>");
			//System.debugOut("plantNum = "+plantNum+" shipDate = "+shipDate);
			
			Events.Query.SystemPerfResponse systemPerfResponse;
			
			if(plantNum!=null && shipDate!=null)
			{
				long ordCreationCheckTime=System.currentTimeMillis() - System.getGlobalVariableAsLong("SLA/INTERVAL/SYSTEM_PERF_WINDOW",1800000);
				String[] watSapSlaCounts=String[3] {};
				String[] sapEtmSlaCounts=String[3] {};
				String[] etmPwmSlaCounts=String[3] {};
			
				System.debugOut("plantNum = "+plantNum+" shipDate = "+shipDate+" ordCreationCheckTime = "+ordCreationCheckTime);
				
				//Checking WATSSAPSystemPerformance.
				 watSapSlaCounts=RuleFunctions.Query.SystemPerformance.watSapSystemPerformance(plantNum/*plantNum String */,shipDate/*shipDate String */,ordCreationCheckTime/*ordCreationCheckTime long */);
				 
				//Checking SAPETMSystemPerformance.
				sapEtmSlaCounts=RuleFunctions.Query.SystemPerformance.sapEtmSystemPerformance(plantNum/*plantNum String */,shipDate/*shipDate String */,ordCreationCheckTime/*ordCreationCheckTime long */);
				
				//Checking ETMPWMSystemPerformance.
				etmPwmSlaCounts=RuleFunctions.Query.SystemPerformance.etmPwmSystemPerformance(plantNum/*plantNum String */,shipDate/*shipDate String */,ordCreationCheckTime/*ordCreationCheckTime long */);
				
				systemPerfResponse=Event.createEvent("xslt://{{/Events/Query/SystemPerfResponse}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"shipDate\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"watSapSlaCounts\"/>\n    <xsl:param name=\"sapEtmSlaCounts\"/>\n    <xsl:param name=\"etmPwmSlaCounts\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:SystemPerformanceResponse>\n                        <ns:SysPerfResponse>\n                            <ns:PlantNum>\n                                <xsl:value-of select=\"$plantNum\"/>\n                            </ns:PlantNum>\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$shipDate\"/>\n                            </ns:ShipDate>\n                            <ns:System_Name>\n                                <xsl:value-of select=\"$globalVariables/OrderSystems/SystemPerformance/WATS-SAP\"/>\n                            </ns:System_Name>\n                            <xsl:if test=\"$watSapSlaCounts/elements[1]\">\n                                <ns:PassCount>\n                                    <xsl:value-of select=\"$watSapSlaCounts/elements[1]\"/>\n                                </ns:PassCount>\n                            </xsl:if>\n                            <ns:LateCount>\n                                <xsl:value-of select=\"$watSapSlaCounts/elements[2]\"/>\n                            </ns:LateCount>\n                            <ns:FailCount>\n                                <xsl:value-of select=\"$watSapSlaCounts/elements[3]\"/>\n                            </ns:FailCount>\n                        </ns:SysPerfResponse>\n                        <ns:SysPerfResponse>\n                            <ns:PlantNum>\n                                <xsl:value-of select=\"$plantNum\"/>\n                            </ns:PlantNum>\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$shipDate\"/>\n                            </ns:ShipDate>\n                            <ns:System_Name>\n                                <xsl:value-of select=\"$globalVariables/OrderSystems/SystemPerformance/SAP-ETM\"/>\n                            </ns:System_Name>\n                            <xsl:if test=\"$sapEtmSlaCounts/elements[1]\">\n                                <ns:PassCount>\n                                    <xsl:value-of select=\"$sapEtmSlaCounts/elements[1]\"/>\n                                </ns:PassCount>\n                            </xsl:if>\n                            <ns:LateCount>\n                                <xsl:value-of select=\"$sapEtmSlaCounts/elements[2]\"/>\n                            </ns:LateCount>\n                            <ns:FailCount>\n                                <xsl:value-of select=\"$sapEtmSlaCounts/elements[3]\"/>\n                            </ns:FailCount>\n                        </ns:SysPerfResponse>\n                        <ns:SysPerfResponse>\n                            <ns:PlantNum>\n                                <xsl:value-of select=\"$plantNum\"/>\n                            </ns:PlantNum>\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$shipDate\"/>\n                            </ns:ShipDate>\n                            <ns:System_Name>\n                                <xsl:value-of select=\"$globalVariables/OrderSystems/SystemPerformance/ETM-PWM\"/>\n                            </ns:System_Name>\n                            <xsl:if test=\"$etmPwmSlaCounts/elements[1]\">\n                                <ns:PassCount>\n                                    <xsl:value-of select=\"$etmPwmSlaCounts/elements[1]\"/>\n                                </ns:PassCount>\n                            </xsl:if>\n                            <ns:LateCount>\n                                <xsl:value-of select=\"$etmPwmSlaCounts/elements[2]\"/>\n                            </ns:LateCount>\n                            <ns:FailCount>\n                                <xsl:value-of select=\"$etmPwmSlaCounts/elements[3]\"/>\n                            </ns:FailCount>\n                        </ns:SysPerfResponse>\n                    </ns:SystemPerformanceResponse>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
			}
			else
			{
				systemPerfResponse=Event.createEvent("xslt://{{/Events/Query/SystemPerfResponse}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"plantNum\"/>\n    <xsl:param name=\"shipDate\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:SystemPerformanceResponse>\n                        <ns:SysPerfResponse>\n                            <ns:PlantNum>\n                                <xsl:value-of select=\"$plantNum\"/>\n                            </ns:PlantNum>\n                            <ns:ShipDate>\n                                <xsl:value-of select=\"$shipDate\"/>\n                            </ns:ShipDate>\n                            <ns:System_Name>\n                                <xsl:value-of select=\"&quot;Invalid Input&quot;\"/>\n                            </ns:System_Name>\n                            <ns:PassCount>\n                                <xsl:value-of select=\"0\"/>\n                            </ns:PassCount>\n                            <ns:LateCount>\n                                <xsl:value-of select=\"0\"/>\n                            </ns:LateCount>\n                            <ns:FailCount>\n                                <xsl:value-of select=\"0\"/>\n                            </ns:FailCount>\n                        </ns:SysPerfResponse>\n                    </ns:SystemPerformanceResponse>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>");
			}
			Event.replyEvent(SystemPerfRequest,systemPerfResponse);
			
		}
		catch(Exception e)
		{
			System.debugOut("Exception caught in processing SystemPerfRequestPP Query Agent = "+e);
			Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/ExceptionEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" version=\"1.0\" exclude-result-prefixes=\"xsl ns xsd\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"e\"/>\n    <xsl:param name=\"SystemPerfRequest\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns:ExceptionRequest>\n                        <ns:Header>\n                            <ns:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns:ApplicationID>\n                            <ns:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns:ServiceName>\n                            <ns:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/Query\"/>\n                            </ns:ComponentName>\n                            <ns:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns:Hostname>\n                            <ns:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns:Timestamp>\n                            <ns:TransactionType>\n                                <xsl:value-of select=\"&quot;SYSTEM PERFORMANCE&quot;\"/>\n                            </ns:TransactionType>\n                        </ns:Header>\n                        <ns:Category>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorCategory\"/>\n                        </ns:Category>\n                        <ns:Type>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorType\"/>\n                        </ns:Type>\n                        <ns:Severity>\n                            <xsl:value-of select=\"$globalVariables/CLEparams/DefaultErrorSeverity\"/>\n                        </ns:Severity>\n                        <ns:Code>\n                            <xsl:value-of select=\"$e/@errorType\"/>\n                        </ns:Code>\n                        <xsl:if test=\"$e/@message\">\n                            <ns:Message>\n                                <xsl:value-of select=\"$e/@message\"/>\n                            </ns:Message>\n                        </xsl:if>\n                        <ns:TransactionData>\n                            <xsl:value-of select=\"string($SystemPerfRequest)\"/>\n                        </ns:TransactionData>\n                        <ns:DumpAnalysis>\n                            <xsl:value-of select=\"string($e)\"/>\n                        </ns:DumpAnalysis>\n                    </ns:ExceptionRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
		}
			
		finally
		{
			//End Logging.
			if(cleFlag)
			{
				Event.sendEvent(Event.createEvent("xslt://{{/Events/Common/LogEvent}}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsl:stylesheet xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ns=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd5\" xmlns:ns1=\"http://www.PepsiCo.com/unique/default/namespace/CommonLE\" xmlns:ns2=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd3\" xmlns:ns3=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd2\" xmlns:ns4=\"http://www.pepsico.com/schemas/practice/Schemas/Schema.xsd4\" xmlns:ns5=\"http://www.tibco.com/schemas/GESEventsMonitoring/SharedResources/SchemaDefinitions/Input/Schema.xsd\" version=\"1.0\" exclude-result-prefixes=\"ns2 ns1 xsl ns4 ns ns3 xsd ns5\">\n    <xsl:output method=\"xml\"/>\n    <xsl:param name=\"globalVariables\"/>\n    <xsl:param name=\"gesAgentId\"/>\n    <xsl:param name=\"SystemPerfRequest\"/>\n    <xsl:template match=\"/\">\n        <createEvent>\n            <event>\n                <payload>\n                    <ns1:LogRequest>\n                        <ns1:Header>\n                            <ns1:ApplicationID>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_Applicationid\"/>\n                            </ns1:ApplicationID>\n                            <ns1:ServiceName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ServiceName\"/>\n                            </ns1:ServiceName>\n                            <ns1:ComponentName>\n                                <xsl:value-of select=\"$globalVariables/CLEparams/CLE_ComponentNames/Query\"/>\n                            </ns1:ComponentName>\n                            <ns1:Hostname>\n                                <xsl:value-of select=\"$gesAgentId\"/>\n                            </ns1:Hostname>\n                            <ns1:Timestamp>\n                                <xsl:value-of select=\"current-dateTime()\"/>\n                            </ns1:Timestamp>\n                            <ns1:TransactionType>\n                                <xsl:value-of select=\"&quot;SYSTEM PERFORMANCE&quot;\"/>\n                            </ns1:TransactionType>\n                        </ns1:Header>\n                        <ns1:Messages>\n                            <ns1:Name>\n                                <xsl:value-of select=\"&quot;LOG_MSG&quot;\"/>\n                            </ns1:Name>\n                            <ns1:Value>\n                                <xsl:value-of select=\"concat(&quot;Completed Querying System performance of PlantNum =  &quot;,$SystemPerfRequest/payload/ns:SystemPerformanceRequest/ns:SysPerfRequest/ns:PlantNum,&quot; on &quot;, $SystemPerfRequest/payload/ns:SystemPerformanceRequest/ns:SysPerfRequest/ns:ShipDate)\"/>\n                            </ns1:Value>\n                        </ns1:Messages>\n                        <ns1:Status>\n                            <xsl:value-of select=\"&quot;End Log&quot;\"/>\n                        </ns1:Status>\n                        <ns1:TransactionBefore>\n                            <xsl:value-of select=\"string($SystemPerfRequest)\"/>\n                        </ns1:TransactionBefore>\n                    </ns1:LogRequest>\n                </payload>\n            </event>\n        </createEvent>\n    </xsl:template>\n</xsl:stylesheet>"));
			}
			
			//Consuming/Deleting event.
			Event.consumeEvent(SystemPerfRequest);
		}
	}
}